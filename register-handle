<?php
$firstname = $lastname = $email = $emailErr = $username = $password = $school = "";

if ($_SERVER["REQUEST_METHOD"] == "POST") 
{	
	// TODO validate other fields 
	$username = test_input($_POST["username"]);
	$email = test_input($_POST["email"]);
	if (!filter_var($email, FILTER_VALIDATE_EMAIL)) 
	{
		$emailErr = "Invalid email format"; 
	}
	
	$password = test_input($_POST["password"]);
}

function test_input($data) 
{
	$data = trim($data);
	$data = stripslashes($data);
	$data = htmlspecialchars($data);
	return $data;
}

// Query MySQL DB
$host     = "localhost";
$port     = 3306;
$socket   = "";
$dbname   = "uga_wall";
$connectStatus = "";

$conn = new mysqli($host, "root", "", $dbname, $port, $socket);

if ($conn->connect_error) 
{
	$connectStatus = "Connection failed: " . $conn->connect_error;
	//header("Location error.php");
} 
else
{
	$connectStatus = "Connected to " . $dbname . " successfully";
}

// Query db
$stmtSelect = $conn->prepare("SELECT username, email FROM ugawall_users");
$stmtSelect->execute();
$result = $stmtSelect->get_result();

$stmtInsert = $conn->prepare("INSERT INTO ugawall_users (username, password, email) VALUES (?, ?, ?)");
$stmtInsert->bind_param("sss", $username, $password, $email);

$user = "";
$emaildb = "";
$outcome = "";
$reg_err = False;

if ($result->num_rows > 0) 
{
    // fetch data of each row
    while($row = $result->fetch_assoc()) 
	{
		$user = $row["username"];
		$emaildb = $row["email"];
		if($user == $username || $emaildb == $email)
		{
			$outcome = "Sorry, that username or email is already on record. <br>Registration failed.";
			$reg_err = True;
			break;
		}
    }
	if(!$reg_err)
	{
		// success, execute insert
		
		$stmtInsert->execute();
		$outcome = "Registration successful! <br>Welcome " . $username;
		//header("Location: /www/Protelog/Views/Account/confirm_email.php");
		exit();
	}
} 
else 
{
    $outcome = "0 results";
}

$stmtInsert->close();
$stmtSelect->close();
$conn->close();
?>

<h1>
	<?php 
		if($reg_err)
		{
			echo "<span style='color:red;'>Sorry, we could not register that account. <br>That email or username is already on record.</span>"; 
		}
		else
		{
			echo "<span style='color:green;'>Registration Successful! <br>Welcome " . $email . "!</span>"; 
		}
	?>
</h1>
<hr/>
